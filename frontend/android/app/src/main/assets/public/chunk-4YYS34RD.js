import{Q as D,R as z,S as K,a as F,b as O,c as U,d as $,e as B,f as L,g as q,h as J,i as v,j as C,k as x,p as E,q as I,r as M,s as G}from"./chunk-MPTE3GQA.js";import{a,b as R,e as P}from"./chunk-JHI3MBHO.js";var _=Symbol("DEEP_SIGNAL");function H(e){return new Proxy(e,{has(t,n){return!!this.get(t,n,void 0)},get(t,n){let o=D(t);return!re(o)||!(n in o)?(M(t[n])&&t[n][_]&&delete t[n],t[n]):(M(t[n])||(Object.defineProperty(t,n,{value:z(()=>t()[n]),configurable:!0}),t[n][_]=!0),H(t[n]))}})}var oe=[WeakSet,WeakMap,Promise,Date,Error,RegExp,ArrayBuffer,DataView,Function];function re(e){if(e===null||typeof e!="object"||se(e))return!1;let t=Object.getPrototypeOf(e);if(t===Object.prototype)return!0;for(;t&&t!==Object.prototype;){if(oe.includes(t.constructor))return!1;t=Object.getPrototypeOf(t)}return t===Object.prototype}function se(e){return typeof e?.[Symbol.iterator]=="function"}var ie=new WeakMap,p=Symbol("STATE_SOURCE");function w(e,...t){let n=D(()=>Y(e)),o=t.reduce((c,i)=>a(a({},c),typeof i=="function"?i(c):i),n),r=e[p],s=Reflect.ownKeys(e[p]);for(let c of Reflect.ownKeys(o))if(s.includes(c)){let i=c;n[i]!==o[i]&&r[i].set(o[i])}ae(e)}function Y(e){let t=e[p];return Reflect.ownKeys(e[p]).reduce((n,o)=>{let r=t[o]();return R(a({},n),{[o]:r})},{})}function ce(e){return ie.get(e[p])||[]}function ae(e){let t=ce(e);for(let n of t){let o=D(()=>Y(e));n(o)}}function V(...e){let t=[...e],n=typeof t[0]=="function"?{}:t.shift(),o=t;return(()=>{class s{constructor(){let i=o.reduce((u,k)=>k(u),le()),{stateSignals:m,props:h,methods:f,hooks:b}=i,d=a(a(a({},m),h),f);this[p]=i[p];for(let u of Reflect.ownKeys(d))this[u]=d[u];let{onInit:S,onDestroy:g}=b;S&&S(),g&&x(I).onDestroy(g)}static \u0275fac=function(m){return new(m||s)};static \u0275prov=C({token:s,factory:s.\u0275fac,providedIn:n.providedIn||null})}return s})()}function le(){return{[p]:{},stateSignals:{},props:{},methods:{},hooks:{}}}function X(e){return t=>{let n=e(a(a(a({[p]:t[p]},t.stateSignals),t.props),t.methods));return R(a({},t),{methods:a(a({},t.methods),n)})}}function Z(e){return t=>{let n=typeof e=="function"?e():e,o=Reflect.ownKeys(n),r=t[p],s={};for(let c of o)r[c]=G(n[c]),s[c]=H(r[c]);return R(a({},t),{stateSignals:a(a({},t.stateSignals),s)})}}function N(e,t){let n=t?.injector??x(E),o=new U,r=e(o).subscribe();n.get(I).onDestroy(()=>r.unsubscribe());let s=(c,i)=>{if(ue(c))return o.next(c),{destroy:F};let m=fe(),h=i?.injector??m??n;if(M(c)){let b=K(()=>{let d=c();D(()=>o.next(d))},{injector:h});return r.add({unsubscribe:()=>b.destroy()}),b}let f=c.subscribe(b=>o.next(b));return r.add(f),h!==n&&h.get(I).onDestroy(()=>f.unsubscribe()),{destroy:()=>f.unsubscribe()}};return s.destroy=r.unsubscribe.bind(r),s}function ue(e){return!M(e)&&!L(e)}function fe(){try{return x(E)}catch{return}}var Q=(()=>{let t=class t{constructor(){typeof Worker<"u"&&(this.worker=new Worker(new URL("worker-F5ZSONMY.js",import.meta.url),{type:"module"}))}transcribe(o){return P(this,null,function*(){let r=performance.now();if(!this.worker)throw new Error("Web Workers are not supported in this browser");let s=yield o.arrayBuffer(),i=yield new AudioContext().decodeAudioData(s),m=16e3,h,f;if(i.numberOfChannels===2){let d=Math.sqrt(2),S=i.getChannelData(0),g=i.getChannelData(1);f=new Float32Array(S.length);for(let u=0;u<i.length;++u)f[u]=d*(S[u]+g[u])/2}else f=i.getChannelData(0);if(i.sampleRate!==m){let d=new AudioBuffer({numberOfChannels:1,length:f.length,sampleRate:i.sampleRate});d.getChannelData(0).set(f);let g=new OfflineAudioContext(1,Math.round(d.length*m/i.sampleRate),m),u=g.createBufferSource();u.buffer=d,u.connect(g.destination),u.start(),h=(yield g.startRendering()).getChannelData(0)}else h=f;let b=h.length/m;return console.log(`Transcribing ${b.toFixed(1)}s of audio`),new Promise((d,S)=>{if(!this.worker){S(new Error("Worker not available"));return}let g=u=>{let{status:k,data:ee,error:te}=u.data;if(k==="complete"){let l=ee;this.worker?.removeEventListener("message",g);let W=l?.chunks?.length||0;console.log(`Chunks: ${W}`),l?.chunks&&Array.isArray(l.chunks)&&l.chunks.forEach((T,j)=>{console.log(`Chunk ${j+1}/${W}:`,T.text?.trim()||"")});let y="";if(l?.text&&l.text.trim().length>0){if(y=l.text,console.log(`result.text length: ${y.length} chars`),l?.chunks&&l.chunks.length>1){let j=l.chunks.map(A=>A.text?.trim()||"").filter(A=>A.length>0).join(" ").trim();j.length>y.length&&(y=j,console.log(`Using merged chunks (${y.length} chars)`))}}else l?.chunks&&Array.isArray(l.chunks)&&l.chunks.length>0?(y=l.chunks.map(j=>j.text?.trim()||"").filter(j=>j.length>0).join(" ").trim(),console.log(`Merged from chunks: ${y.length} chars`)):typeof l=="string"&&(y=l);console.log(`Final text: ${y.length} chars`),d({text:y.trim(),language:l?.language??l?.language_detection?.language,duration:Math.round((performance.now()-r)/100)/10})}else k==="error"?(this.worker?.removeEventListener("message",g),S(new Error(te||"Transcription failed"))):k==="update"&&console.log("Progress update:",u.data)};this.worker.addEventListener("message",g),this.worker.postMessage({type:"transcribe",audio:h,model:"Xenova/whisper-base",quantized:!0},[h.buffer])})})}};t.\u0275fac=function(r){return new(r||t)},t.\u0275prov=C({token:t,factory:t.\u0275fac,providedIn:"root"});let e=t;return e})();var de={notes:[],loading:!1},Ee=V({providedIn:"root"},Z(de),X((e,t=x(Q))=>({loadNotes:N(O(v(()=>w(e,{loading:!0})),v(()=>{let n=localStorage.getItem("whisper-notes"),o=n?JSON.parse(n):[];w(e,{notes:o,loading:!1})}))),addNote:n=>{let o=[...e.notes(),n];w(e,{notes:o}),localStorage.setItem("whisper-notes",JSON.stringify(o))},deleteNote:n=>{let o=e.notes().filter(r=>r.id!==n);w(e,{notes:o}),localStorage.setItem("whisper-notes",JSON.stringify(o))},transcribe:N(O(v(()=>w(e,{loading:!0})),J(({file:n,source:o})=>B(t.transcribe(n)).pipe(v(r=>{let s={id:crypto.randomUUID(),title:r.text.slice(0,60)||"Transcribed note",body:r.text.trim(),createdAt:Date.now(),source:o,language:r.language,duration:r.duration},c=[...e.notes(),s];w(e,{notes:c,loading:!1}),localStorage.setItem("whisper-notes",JSON.stringify(c))}),q(r=>(console.error("Transcription failed",r),w(e,{loading:!1}),$)))))),updateNote:(n,o)=>{let r=e.notes().map(s=>s.id===n?a(a({},s),o):s);w(e,{notes:r}),localStorage.setItem("whisper-notes",JSON.stringify(r))},reorderNotes:(n,o)=>{let r=[...e.notes()],[s]=r.splice(n,1);r.splice(o,0,s),w(e,{notes:r}),localStorage.setItem("whisper-notes",JSON.stringify(r))}})));export{Ee as a};
